---
import SkillCategory from './SkillCategory.astro';

interface Publication {
	title: string;
	url: string;
}

interface Props {
	title: string;
	company: string;
	period: string;
	startDate: string; // Format: "YYYY-MM" for timeline positioning
	endDate?: string; // Format: "YYYY-MM" or "Present" for timeline display
	responsibilities: string[];
	skills?: string[];
	publications?: Publication[];
}

const { title, company, period, startDate, endDate, responsibilities, skills, publications } = Astro.props;

// Function to format date for timeline display
function formatTimelineDate(dateStr: string): string {
	if (dateStr === 'Present') return 'Present';
	
	const [year, month] = dateStr.split('-');
	const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
	const monthName = monthNames[parseInt(month) - 1];
	const shortYear = year.slice(-2); // Get last 2 digits of year
	return `${monthName} ${shortYear}`;
}

// Create the display range
const startDisplay = formatTimelineDate(startDate);
const endDisplay = endDate ? formatTimelineDate(endDate) : 'Present';
const dateRange = `${startDisplay} - ${endDisplay}`;
---

<div class="timeline-item">
	<div class="timeline-marker">
		<div class="timeline-dot"></div>
		<div class="timeline-date">
			<div class="timeline-range">{dateRange}</div>
		</div>
	</div>

	<div class="timeline-content">
		<div class="job-header">
			<h3>{title}</h3>
			<div class="job-meta">
				<span class="company">{company}</span>
				<span class="period">{period}</span>
			</div>
		</div>

		<ul class="responsibilities">
			{responsibilities.map((responsibility) => <li>{responsibility}</li>)}
		</ul>

		{skills && <SkillCategory title="Skills" skills={skills} />}

		{
			publications && publications.length > 0 && (
				<div class="publications">
					<h4>Related Publications</h4>
					<ul class="publication-list">
						{publications.map((pub) => (
							<li>
								<a href={pub.url} target="_blank" rel="noopener noreferrer">
									{pub.title}
								</a>
							</li>
						))}
					</ul>
				</div>
			)
		}
	</div>
</div>

<style>
	.timeline-item {
		position: relative;
		display: flex;
		margin-bottom: 3rem;
		padding-left: 0;
	}

	.timeline-marker {
		position: relative;
		display: flex;
		flex-direction: column;
		align-items: center;
		margin-right: 2rem;
		min-width: 80px;
	}

	.timeline-dot {
		width: 16px;
		height: 16px;
		background-color: var(--color-secondary);
		border-radius: 50%;
		border: 3px solid var(--color-background);
		box-shadow: 0 0 0 3px var(--color-secondary);
		z-index: 2;
		margin-bottom: 0.5rem;
	}

	.timeline-date {
		text-align: center;
		position: sticky;
		top: 2rem;
		background-color: var(--color-background);
		padding: 0.5rem;
		border-radius: var(--radius-sm);
		border: 1px solid var(--color-border);
		min-width: 80px;
		z-index: 3;
	}

	.timeline-range {
		font-size: 0.75rem;
		font-weight: 600;
		color: var(--color-secondary);
		text-transform: uppercase;
		letter-spacing: 0.5px;
		white-space: nowrap;
	}

	.timeline-content {
		flex: 1;
		background-color: var(--color-background);
		border: 1px solid var(--color-border);
		border-radius: var(--radius-md);
		padding: 1.5rem;
		box-shadow: var(--shadow-card);
	}

	.job-header {
		margin-bottom: 1.5rem;
	}

	.job-header h3 {
		font-size: 1.4rem;
		margin-bottom: 0.5rem;
		color: var(--color-text);
	}

	.job-meta {
		display: flex;
		justify-content: space-between;
		flex-wrap: wrap;
		gap: 0.5rem;
		color: var(--color-text-light);
		font-size: 0.9rem;
	}

	.company {
		font-weight: 600;
	}

	.responsibilities {
		margin-bottom: 1.5rem;
		padding-left: 1.25rem;
	}

	.responsibilities li {
		margin-bottom: 0.75rem;
		line-height: 1.5;
	}

	.publications {
		margin-top: 1.5rem;
		padding-top: 1.5rem;
		border-top: 1px solid var(--color-border);
	}

	.publications h4 {
		font-size: 1.1rem;
		margin-bottom: 1rem;
		color: var(--color-text-light);
	}

	.publication-list {
		list-style: none;
		padding-left: 0;
	}

	.publication-list li {
		margin-bottom: 0.5rem;
	}

	.publication-list a {
		color: var(--color-text);
		text-decoration: none;
		font-size: 0.9rem;
		border-bottom: 1px solid var(--color-primary);
	}

	.publication-list a:hover {
	}

	/* Timeline line connecting dots */
	.timeline-item:not(:last-child) .timeline-marker::after {
		content: '';
		position: absolute;
		top: 20px;
		left: 50%;
		transform: translateX(-50%);
		width: 2px;
		height: calc(100% + 3rem);
		background: linear-gradient(to bottom, var(--color-secondary) 0%, var(--color-secondary) 100%);
		z-index: 1;
	}

	@media (max-width: 768px) {
		.timeline-item {
			flex-direction: column;
			margin-bottom: 2rem;
		}

		.timeline-marker {
			flex-direction: row;
			align-items: center;
			margin-right: 0;
			margin-bottom: 1rem;
			min-width: auto;
		}

		.timeline-dot {
			margin-right: 1rem;
			margin-bottom: 0;
		}

		.timeline-date {
			position: static;
			min-width: auto;
		}

		.timeline-item:not(:last-child) .timeline-marker::after {
			display: none;
		}
	}

	@media (prefers-color-scheme: dark) {
		.timeline-content {
			background-color: var(--color-background-hover);
		}

		.timeline-date {
			background-color: var(--color-background-hover);
		}
	}
</style>
